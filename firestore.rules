rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── helpers ────────────────────────────────────────────────
    function isAdmin() {
      return request.auth != null
        && get(/databases/$(database)/documents/drivers/$(request.auth.uid)).data.role == "admin";
    }

    function isDriver(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // ── drivers ────────────────────────────────────────────────
    // Admin : lecture/écriture totale
    // Driver : lecture de son propre doc, écriture partielle (iban, status)
    match /drivers/{uid} {
      allow read:  if isAdmin() || isDriver(uid);
      allow write: if isAdmin();
      allow update: if isDriver(uid)
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(["iban", "paymentMethod", "status", "isOnline", "lastSeen"]);
    }

    // ── driver_applications ────────────────────────────────────
    // Utilisé pour l'authentification livreur existante
    match /driver_applications/{docId} {
      allow read:  if isAdmin()
        || (request.auth != null && resource.data.uid == request.auth.uid);
      allow write: if isAdmin();
      // Livreur peut mettre à jour son password et contractAccepted
      allow update: if request.auth != null
        && resource.data.uid == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
             .hasOnly(["password", "passwordSet", "contractAccepted", "contractAcceptedAt"]);
    }

    // ── deliveries ─────────────────────────────────────────────
    // Admin : lecture/écriture totale
    // Driver : lecture de ses propres livraisons uniquement
    match /deliveries/{deliveryId} {
      allow read:   if isAdmin()
        || (request.auth != null && resource.data.driverId == request.auth.uid);
      allow write:  if isAdmin();
      allow create: if isAdmin();
    }

    // ── payouts ────────────────────────────────────────────────
    // Admin : lecture/écriture totale
    // Driver : lecture de ses propres payouts
    match /payouts/{payoutId} {
      allow read:  if isAdmin()
        || (request.auth != null && resource.data.driverId == request.auth.uid);
      allow write: if isAdmin();
    }

    // ── relays ────────────────────────────────────────────────
    // Lecture publique (authentification relai par PIN côté API)
    // Écriture réservée à l'admin
    match /relays/{relayId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ── relayLogs ─────────────────────────────────────────────
    // Lecture publique (stats relai)
    // Création publique (scan QR par l'opérateur relai)
    // Mise à jour/suppression réservées à l'admin
    match /relayLogs/{logId} {
      allow read:   if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // ── orders ────────────────────────────────────────────────
    // Lecture publique (nécessaire pour le scan QR relai)
    // Création publique (passage de commande client)
    // Mise à jour limitée : admin OU opérateur relai (COLLECTED uniquement)
    match /orders/{orderId} {
      allow read:   if true;
      allow write:  if isAdmin();
      allow create: if true;
      // Opérateur relai peut uniquement marquer une commande comme COLLECTED
      allow update: if isAdmin()
        || (
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(["status", "collectedAt", "collectedBy", "updatedAt"])
          && request.resource.data.status == "COLLECTED"
        );
    }

    // ── autres collections existantes ─────────────────────────
    match /settings/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /products/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /categories/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /banners/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /coupons/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /packs/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    match /users/{uid} {
      allow read:  if isAdmin() || isDriver(uid);
      allow write: if isAdmin() || isDriver(uid);
    }

    match /driver_locations/{uid} {
      allow read:  if isAdmin()
        || (request.auth != null && uid == request.auth.uid);
      allow write: if request.auth != null && uid == request.auth.uid;
    }

    // ── pickup_locations ───────────────────────────────────────
    match /pickup_locations/{doc} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ── fraud_events ───────────────────────────────────────────
    // Seul l'admin peut lire/écrire les événements de fraude.
    // Les drivers ne voient JAMAIS leurs fraud_events.
    match /fraud_events/{eventId} {
      allow read:  if isAdmin();
      allow write: if isAdmin();
    }

    // ── notifications ──────────────────────────────────────────
    // Alertes système (ex: blocage auto driver). Admin RW uniquement.
    match /notifications/{docId} {
      allow read:  if isAdmin();
      allow write: if isAdmin();
    }

    // ── boost_state ────────────────────────────────────────────
    // Lecture autorisée à tous les drivers authentifiés (badge boost actif).
    // Écriture réservée à l'admin (via API route avec ADMIN_SECRET).
    match /boost_state/{doc} {
      allow read:  if isAdmin() || request.auth != null;
      allow write: if isAdmin();
    }

    // ── promotions ─────────────────────────────────────────────
    // Lecture publique (affichage bannière client).
    // Écriture réservée à l'admin (créer, activer, stopper une promo).
    match /promotions/{promoId} {
      allow read:  if true;
      allow write: if isAdmin();
    }

    // ── promotion_events ───────────────────────────────────────
    // Écriture publique : tracking client (impression, click, add_to_cart, checkout_success).
    // Lecture réservée à l'admin (analytics).
    match /promotion_events/{eventId} {
      allow read:  if isAdmin();
      allow write: if true;
    }

    // ── wallet_transactions ─────────────────────────────────────
    // Livreur : lecture de ses propres transactions
    // Écriture réservée au serveur (via Admin SDK)
    match /wallet_transactions/{txId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
